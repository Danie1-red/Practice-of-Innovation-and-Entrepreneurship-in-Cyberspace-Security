以下是论文中 **Section 3.1: Protocol details** 的总结及 **Figure 2 协议原理**的详细解析：

---

### **Section 3.1 核心总结**
1. **协议目标**：  
   - 解决 **Private Intersection-Sum with Cardinality（PI-Sum-C）** 问题：  
     - 两方（P₁ 和 P₂）持有用户标识符集合。  
     - P₂ 额外拥有每个标识符的整数值（如广告转化金额）。  
     - 双方需计算：  
       - **交集大小（Cardinality）**：共同标识符的数量。  
       - **交集和（Intersection-Sum）**：交集标识符对应值的总和。  
     - **隐私要求**：除上述两个结果外，不泄露任何其他信息（如具体标识符、非交集的值）。

2. **协议选择原因**：  
   - **简单性**：基于经典 DDH 假设和成熟密码原语（如 Pohlig-Hellman 密码系统）。  
   - **通信高效**：在批处理场景下，通信开销是主要成本（优于计算开销）。  
   - **半诚实安全模型**：满足实际部署的隐私需求（参与者遵守协议但可能窃听）。  
   - **扩展性**：支持阈值过滤、多值统计等变体。

3. **密码基础**：  
   - **DDH 困难假设**：在群 \(\mathcal{G}\) 中判定 Diffie-Hellman 三元组困难。  
   - **加法同态加密**：支持密文求和（如 Paillier/Damgård-Jurik 方案）。  
   - **随机预言机（ROM）**：哈希函数 \(H\) 被建模为随机预言机。

---

### **Figure 2 协议原理详解**
协议分为 **3 轮交互**，流程如下（结合图示）：  
![Figure 2 Protocol Flow](https://via.placeholder.com/400x200?text=DDH-Based+PI-Sum+Protocol)

#### **输入与初始化**
- **P₁**：标识符集合 \(V = \{v_1, \dots, v_{m_1}\}\)。  
- **P₂**：标识符-值对集合 \(W = \{(w_1, t_1), \dots, (w_{m_2}, t_{m_2})\}\)。  
- **公共参数**：  
  - 群 \(\mathcal{G}\)（DDH 困难，如椭圆曲线 `prime256v1`）。  
  - 加法同态加密方案（如 Paillier）。  
  - 随机预言机 \(H: \mathcal{U} \to \mathcal{G}\)（如 SHA-256）。

#### **协议步骤**
1. **Round 1 (P₂ → P₁)**：  
   - P₂ 对每个 \(w_j\) 计算：  
     - **单掩码**：\(H(w_j)^{k_2}\)（用私钥 \(k_2\) 加密标识符）。  
     - **值加密**：\(\text{AEnc}(t_j)\)（同态加密值 \(t_j\)）。  
   - 发送 **乱序集合**：\(\{ (H(w_j)^{k_2}, \text{AEnc}(t_j)) \}_{j=1}^{m_2}\)（隐藏原始顺序）。

2. **Round 2 (P₁ → P₂)**：  
   - P₁ 对接收的每对数据：  
     - **双掩码**：计算 \((H(w_j)^{k_2})^{k_1} = H(w_j)^{k_1 k_2}\)（用私钥 \(k_1\) 二次加密）。  
     - **洗牌**：生成随机排列 \(\pi\)，重排所有 \(H(w_j)^{k_1 k_2}\) 和对应的 \(\text{AEnc}(t_j)\)。  
   - 发送 **乱序+双掩码集合**：\(\{ (H(w_j)^{k_1 k_2}, \text{AEnc}(t_j)) \}_{j=1}^{m_2}\)（按 \(\pi\) 重排）。  
   - **额外发送**：P₁ 自身标识符的单掩码集合 \(\{ H(v_i)^{k_1} \}_{i=1}^{m_1}\)（乱序）。

3. **Round 3 (P₂ → P₁)**：  
   - P₂ 计算：  
     - **双掩码 P₁ 标识符**：对每个 \(H(v_i)^{k_1}\) 计算 \((H(v_i)^{k_1})^{k_2} = H(v_i)^{k_1 k_2}\)。  
     - **求交集**：  
       - 比较双掩码集合 \(\{ H(v_i)^{k_1 k_2} \}_{i=1}^{m_1}\) 与 \(\{ H(w_j)^{k_1 k_2} \}_{j=1}^{m_2}\)。  
       - 记录匹配索引 \(j \in J\)（交集标识符位置）。  
     - **同态求和**：计算 \(\text{ASum}_{j \in J} \text{AEnc}(t_j) = \text{AEnc}(\sum_{j \in J} t_j)\)。  
   - 发送 **交集大小 \(|J|\)** 和 **加密的和 \(\text{AEnc}(S_J)\)** 给 P₁。

4. **输出**：  
   - **P₁**：解密 \(\text{AEnc}(S_J)\) 得到交集和 \(S_J = \sum_{j \in J} t_j\)，并获知 \(|J|\)。  
   - **P₂**：仅获知 \(|J|\)（不直接得到 \(S_J\)）。

---

### **关键隐私保护机制**
1. **双掩码（Double Masking）**：  
   - 标识符通过 \(H(\cdot)^{k_1 k_2}\) 转换为伪随机值，双方需合作才能还原（类似共享密钥 OPRF）。  
   - 确保无人能单独关联输入与输出（即使知道 \(k_1\) 或 \(k_2\)）。

2. **洗牌（Shuffling）**：  
   - P₁ 在 Round 2 重排数据顺序，切断 \(H(w_j)^{k_1 k_2}\) 与 \(\text{AEnc}(t_j)\) 的关联。  
   - 防止 P₂ 通过位置推断哪些值被求和。

3. **同态加密（Homomorphic Aggregation）**：  
   - P₂ 仅处理加密值，无法窥探 \(t_j\)；P₁ 仅解密最终和，不获知单个值。  
   - **槽位打包（Slotting）**：Paillier 优化中，多个值被打包进单个密文，减少通信量（如 65 个值/密文）。

---

### **安全性与效率**
- **半诚实安全**：  
  - 模拟证明显示，各方视图仅依赖其输入和输出（交集大小/和）。  
- **效率优势**：  
  - **通信主导**：对 10⁵ 元素，成本仅 **0.084 美分**（Paillier 优化）。  
  - **计算次之**：批处理和非实时执行容忍较高延迟。  

此协议是 **简洁性、成本与隐私的平衡**，成为工业部署的理想选择。后续章节的 ROT/Bloom Filter 协议虽新，但未超越其性价比。
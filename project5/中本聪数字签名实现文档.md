# 中本聪数字签名实现文档

## 概述

本文档描述了基于 ECDSA-secp256k1 的中本聪数字签名系统实现，这是比特币网络中使用的核心签名算法。

## 技术特性

### 1. 椭圆曲线参数 (secp256k1)

```
椭圆曲线方程: y² = x³ + 7 (mod p)
素数域: p = 2^256 - 2^32 - 2^9 - 2^8 - 2^7 - 2^6 - 2^4 - 1
基点G: (0x79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798,
        0x483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8)
基点阶: n = 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141
```

### 2. ECDSA 签名算法

#### 签名生成 (私钥 d, 消息哈希 z)

1. 生成随机数 k ∈ [1, n-1]
2. 计算点 (x₁, y₁) = k·G
3. 计算 r = x₁ mod n，如果 r = 0 则重新选择 k
4. 计算 s = k⁻¹(z + rd) mod n，如果 s = 0 则重新选择 k
5. 应用低 S 规则：如果 s > n/2，则 s = n - s
6. 返回签名 (r, s)

#### 签名验证 (公钥 Q, 消息哈希 z, 签名 (r,s))

1. 验证 1 ≤ r,s < n
2. 计算 w = s⁻¹ mod n
3. 计算 u₁ = zw mod n, u₂ = rw mod n
4. 计算点 (x₁, y₁) = u₁G + u₂Q
5. 验证 r ≡ x₁ (mod n)

### 3. 比特币签名格式

#### DER 编码

```
30 <len> 02 <r-len> <r> 02 <s-len> <s>
```

#### 完整比特币签名

```
<DER签名> <SIGHASH类型>
```

常用 SIGHASH 类型：

- 0x01: SIGHASH_ALL（签名所有输入和输出）
- 0x02: SIGHASH_NONE（签名所有输入）
- 0x03: SIGHASH_SINGLE（签名对应输入输出对）

### 4. 双重 SHA256 哈希

比特币使用双重 SHA256 作为哈希函数：

```
hash = SHA256(SHA256(data))
```

## 实现架构

### 类结构

```python
class Secp256k1:
    """secp256k1椭圆曲线参数"""

class ECPoint:
    """椭圆曲线点类"""

class NakamotoSignature:
    """中本聪数字签名主实现类"""
```

### 核心方法

1. **椭圆曲线运算**

   - `point_add()`: 椭圆曲线点加法
   - `point_double()`: 椭圆曲线点倍加
   - `scalar_mult()`: 标量乘法 k·P

2. **密钥管理**

   - `generate_keypair()`: 生成密钥对
   - 私钥范围验证
   - 公钥有效性检查

3. **签名操作**

   - `sign()`: ECDSA 签名生成
   - `verify()`: ECDSA 签名验证
   - 低 S 规则实施

4. **编码格式**
   - `encode_der()`: DER 编码
   - `decode_der()`: DER 解码
   - `create_bitcoin_signature()`: 比特币签名格式

## 安全特性

### 1. 低 S 规则 (BIP 66)

为防止签名延展性攻击，实施低 S 规则：

- 如果 s > n/2，则使用 s' = n - s
- 确保每个消息只有一个标准签名

### 2. 参数验证

- 私钥范围检查：1 ≤ d < n
- 公钥验证：Q 在椭圆曲线上
- 签名参数检查：1 ≤ r,s < n

### 3. 随机数安全

- 使用密码学安全随机数生成器
- 每次签名使用不同的 k 值
- 防止 k 值重用攻击

## 攻击演示

### 1. k 重用攻击

当使用相同的随机数 k 签名不同消息时：

```
已知：两个签名 (r, s₁) 和 (r, s₂)，相同的 r 值
攻击：k = (z₁ - z₂) / (s₁ - s₂) mod n
      d = (s₁k - z₁) / r mod n
```

### 2. 无效曲线攻击

攻击者可能提供无效的椭圆曲线参数或公钥点。

**防护措施**：

- 验证所有椭圆曲线点在正确曲线上
- 检查曲线参数的有效性

### 3. 时序攻击

通过分析签名生成时间推断私钥信息。

**防护措施**：

- 使用常量时间算法
- 实施侧信道攻击防护

## 使用示例

### 基本签名验证

```python
from nakamoto_signature import NakamotoSignature

# 初始化
nakamoto = NakamotoSignature()

# 生成密钥对
private_key, public_key = nakamoto.generate_keypair()

# 准备消息
message = b"Hello Bitcoin!"
msg_hash = nakamoto.double_sha256(message)

# 签名
signature = nakamoto.sign(msg_hash, private_key)

# 验证
is_valid = nakamoto.verify(msg_hash, signature, public_key)
print(f"签名验证: {is_valid}")
```

### 比特币风格签名

```python
# 创建比特币签名
bitcoin_sig = nakamoto.create_bitcoin_signature(msg_hash, private_key)

# 验证比特币签名
bitcoin_valid = nakamoto.verify_bitcoin_signature(msg_hash, bitcoin_sig, public_key)
print(f"比特币签名验证: {bitcoin_valid}")
```

### 完整演示

```python
# 运行完整演示
demo_result, attack_result = nakamoto.demonstrate_nakamoto_signature()
```

## 测试套件

### 测试覆盖

1. **secp256k1 参数验证**
2. **密钥生成测试**
3. **签名验证测试**
4. **DER 编码测试**
5. **比特币签名格式测试**
6. **k 重用攻击测试**
7. **低 S 规则测试**

### 运行测试

```bash
# 运行基础测试
python src/nakamoto_signature.py

# 运行综合测试
python tests/test_nakamoto_signature.py

# 通过主程序运行
python main.py nakamoto
```

## 性能特征

### 典型性能数据

```
密钥生成: ~0.1ms
签名生成: ~0.2ms
签名验证: ~0.5ms
DER编码: ~0.01ms
```

### 内存使用

- 基本运算：最小内存占用
- 预计算优化：可选的性能提升
- 常量时间实现：防止侧信道攻击

## 与比特币协议的关系

### 交易签名流程

1. **构造原始交易**：包含输入、输出、时间锁等
2. **生成签名哈希**：双重 SHA256 哈希
3. **ECDSA 签名**：使用私钥签名
4. **DER 编码**：标准化签名格式
5. **添加 SIGHASH**：指定签名覆盖范围
6. **构造 scriptSig**：`<sig> <pubkey>`

### Script 引擎验证

```
scriptPubKey: OP_DUP OP_HASH160 <pubKeyHash> OP_EQUALVERIFY OP_CHECKSIG
scriptSig:    <sig> <pubKey>
```

执行过程：

1. 压入签名和公钥
2. `OP_CHECKSIG`验证签名
3. 成功返回 1，失败返回 0

## 安全建议

### 实现安全

1. **使用经过验证的密码学库**
2. **实施完整的参数验证**
3. **采用常量时间算法**
4. **定期安全审计**

### 应用安全

1. **确保随机数质量**
2. **避免 k 值重用**
3. **实施适当的密钥管理**
4. **遵循比特币改进提案(BIP)**

## 扩展方向

### Schnorr 签名 (BIP-340)

比特币 Taproot 升级引入 Schnorr 签名：

- 更短的签名长度 (64 字节 vs 71-72 字节)
- 批量验证能力
- 签名聚合支持
- 更好的隐私保护

### 多签方案

- **多重签名**：传统 m-of-n 方案
- **门限签名**：分布式签名生成
- **聚合签名**：多个签名合并为一个

## 参考资料

1. [SEC 2: Recommended Elliptic Curve Domain Parameters](http://www.secg.org/sec2-v2.pdf)
2. [BIP 66: Strict DER signatures](https://github.com/bitcoin/bips/blob/master/bip-0066.mediawiki)
3. [BIP 340: Schnorr Signatures for secp256k1](https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki)
4. [比特币白皮书](https://bitcoin.org/bitcoin.pdf)
5. [Understanding Cryptography by Christof Paar](https://www.springer.com/gp/book/9783642041006)

---

_本实现仅用于教育目的，生产环境请使用经过安全审计的密码学库。_
